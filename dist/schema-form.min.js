angular.module("schemaForm",[]),angular.module("schemaForm").provider("schemaFormDecorators",["$compileProvider",function(e){var t="",r={},n=function(e,n){"sfDecorator"===e&&(e=t);for(var a=r[e],i=a.rules,o=0;o<i.length;o++){var u=i[o](n);if(u)return u}return a.mappings[n.type]?a.mappings[n.type]:a.mappings["default"]},a=function(t){e.directive(t,["$parse","$compile","$http","$templateCache",function(e,r,a,i){return{restrict:"AE",replace:!0,transclude:!1,scope:!0,require:"?^sfSchema",link:function(e,o,u,c){var l=e.$watch(u.form,function(u){if(u){e.form=u;var c=n(t,u);a.get(c,{cache:i}).then(function(t){var n=t.data.replace(/\$\$value\$\$/g,"model."+(u.key||""));r(n)(e,function(e){o.replaceWith(e)})}),l()}});e.showTitle=function(){return e.form&&e.form.notitle!==!0&&e.form.title},e.checkboxValuesToList=function(e){var t=[];return angular.forEach(e,function(e,r){e&&t.push(r)}),t},e.buttonClick=function(t,r){angular.isFunction(r.onClick)?r.onClick(t,r):angular.isString(r.onClick)&&(c?c.evalInParentScope(r.onClick,{$event:t,form:r}):e.$eval(r.onClick,{$event:t,form:r}))},e.evalExpr=function(t,r){return c?c.evalInParentScope(t,r):e.$eval(t,r)},e.evalInScope=function(t,r){return t?e.$eval(t,r):void 0},e.errorMessage=function(t){return e.form.validationMessage?t?angular.isString(e.form.validationMessage)?e.form.validationMessage:e.form.validationMessage[t.code]||e.form.validationMessage["default"]:e.form.validationMessage.required||e.form.validationMessage["default"]||e.form.validationMessage:t?t.message:"Required"}}}}])},i=function(t,r,n){n=angular.isDefined(n)?n:!1,e.directive("sf"+angular.uppercase(t[0])+t.substr(1),function(){return{restrict:"EAC",scope:!0,replace:!0,transclude:n,template:'<sf-decorator form="form"></sf-decorator>',link:function(e,r,n){var a={items:"c",titleMap:"c",schema:"c"},i={type:t},o=!0;angular.forEach(n,function(t,r){if("$"!==r[0]&&0!==r.indexOf("ng")&&"sfField"!==r){var u=function(t){angular.isDefined(t)&&t!==i[r]&&(i[r]=t,o&&i.type&&(i.key||angular.isUndefined(n.key))&&(e.form=i,o=!1))};"model"===r?e.$watch(t,function(t){t&&e.model!==t&&(e.model=t)}):"c"===a[r]?e.$watchCollection(t,u):n.$observe(r,u)}})}}})};this.createDecorator=function(e,n,i){r[e]={mappings:n||{},rules:i||[]},r[t]||(t=e),a(e)},this.createDirective=i,this.createDirectives=function(e){angular.forEach(e,function(e,t){i(t,e)})},this.directive=function(e){return e=e||t,r[e]},this.$get=function(){return{directive:function(e){return r[e]},defaultDecorator:t}},a("sfDecorator")}]),angular.module("schemaForm").provider("schemaForm",[function(){var e=function(e,t,r){var n=f[t.type];if(n)for(var a,i=0;i<n.length;i++)if(a=n[i](e,t,r))return a},t=function(e,t){var r={};return e.title&&(r.title=e.title),e.description&&(r.description=e.description),(t.required===!0||e.required===!0)&&(r.required=!0),e.default&&(r.default=e.default),e.maxLength&&(r.maxlength=e.maxLength),e.minLength&&(r.minlength=e.maxLength),(e.readOnly||e.readonly)&&(r.readonly=e.readOnly||e.readonly),e.minimum&&(r.minimum=e.minimum+(e.exclusiveMinimum?1:0)),e.maximum&&(r.maximum=e.maximum-(e.exclusiveMaximum?1:0)),e.validationMessage&&(r.validationMessage=e.validationMessage),e.enumNames&&(r.titleMap=e.enumNames),r.schema=e,r},r=function(e,r,n){if("string"===r.type&&!r.enum){var a=t(r,n);return a.key=n.path,a.type="text",n.lookup[n.path]=a,a}},n=function(e,r,n){if("number"===r.type){var a=t(r,n);return a.key=n.path,a.type="number",n.lookup[n.path]=a,a}},a=function(e,r,n){if("integer"===r.type){var a=t(r,n);return a.key=n.path,a.type="number",n.lookup[n.path]=a,a}},i=function(e,r,n){if("boolean"===r.type){var a=t(r,n);return a.key=n.path,a.type="checkbox",n.lookup[n.path]=a,a}},o=function(e,r,n){if("string"===r.type&&r.enum){var a=t(r,n);return a.key=n.path,a.type="select",a.titleMap||(a.titleMap={},r.enum.forEach(function(e){a.titleMap[e]=e})),n.lookup[n.path]=a,a}},u=function(e,r,n){if("array"===r.type&&r.items&&r.items.enum){var a=t(r,n);return a.key=n.path,a.type="checkboxes",a.titleMap||(a.titleMap={},r.items.enum.forEach(function(e){a.titleMap[e]=e})),n.lookup[n.path]=a,a}},c=function(e,r,n){if("string"===r.type&&"date"==r.format){var a=t(r,n);return a.key=n.path,a.type="datepicker",n.lookup[n.path]=a,a}},l=function(r,n,a){if("object"===n.type){var i=t(n,a);return i.type="fieldset",i.items=[],a.lookup[a.path]=i,angular.forEach(n.properties,function(t,r){var o=a.path+"."+r;if(a.ignore[o]!==!0){var u=n.required&&-1!==n.required.indexOf(r),c=e(r,t,{path:o,required:u||!1,lookup:a.lookup,ignore:a.ignore});c&&i.items.push(c)}}),i}},f={string:[o,c,r],object:[l],number:[n],integer:[a],"boolean":[i],array:[u]},s=function(e){return e};this.defaults=f,this.postProcess=function(e){s=e},this.appendRule=function(e,t){f[e]||(f[e]=[]),f[e].push(t)},this.prependRule=function(e,t){f[e]||(f[e]=[]),f[e].unshift(t)},this.createStandardForm=t,this.$get=function(){var t={};return t.merge=function(e,r,n){r=r||["*"];var a=t.defaults(e,n),i=r.indexOf("*");if(-1!==i)return r=r.slice(0,i).concat(a.form).concat(r.slice(i+1));var o=a.lookup;return s(r.map(function(r){return"string"==typeof r&&(r={key:r}),r.items&&(r.items=t.merge(e,r.items,n)),r.key&&o[r.key]?angular.extend(o[r.key],r):r}))},t.defaults=function(t,r){var n=[],a={};if(r=r||{},"object"!==t.type)throw new Error('Not implemented. Only type "object" allowed at root level of schema.');return angular.forEach(t.properties,function(i,o){if(r[o]!==!0){var u=t.required&&-1!==t.required.indexOf(o),c=e(o,i,{path:o,lookup:a,ignore:r,required:u});c&&n.push(c)}}),{form:n,lookup:a}},t}}]),angular.module("ng").directive("pickADate",function(){return{restrict:"A",require:"ngModel",scope:{ngModel:"=",minDate:"=",maxDate:"="},link:function(e,t,r,n){if(t.pickadate){t.pickadate({onClose:function(){t.blur()},formatSubmit:null});var a="yyyy-mm-dd",i=$.fn.pickadate.defaults.format,o=t.pickadate("picker");if(n.$formatters.push(function(e){return angular.isUndefined(e)||null===e?e:(o.set("view",e,{format:r.format||a}),o.set("highlight",e,{format:r.format||a}),o.get("highlight",i))}),n.$parsers.push(function(){return o.get("select",r.format||a)}),angular.isDefined(r.minDate))var u=e.$watch("minDate",function(e){e&&(o.set("min",e),u())},!0);if(angular.isDefined(r.maxDate))var c=e.$watch("maxDate",function(e){e&&(o.set("max",e),c())},!0)}}}}),angular.module("schemaForm").directive("sfChanged",function(){return{require:"ngModel",restrict:"AC",scope:!1,link:function(e,t,r,n){var a=e.$eval(r.sfChanged);a&&a.onChange&&n.$viewChangeListeners.push(function(){angular.isFunction(a.onChange)?a.onChange(n.$modelValue,a):e.evalExpr(a.onChange,{modelValue:n.$modelValue,form:a})})}}}),angular.module("schemaForm").directive("sfSchema",["$compile","schemaForm","schemaFormDecorators",function(e,t,r){function n(e,t){return t=t||"_",e.replace(i,function(e,r){return(r?t:"")+e.toLowerCase()})}var a=function(e,t,r){r=r||"",t(e,r),angular.forEach(e.properties,function(e,n){a(e,t,""===r?n:r+"."+n)})},i=/[A-Z]/g;return{scope:{schema:"=sfSchema",initialForm:"=sfForm",model:"=sfModel"},controller:["$scope",function(e){this.evalInParentScope=function(t,r){return e.$parent.$eval(t,r)}}],replace:!1,restrict:"A",transclude:!0,require:"?form",link:function(i,o,u,c,l){i.formCtrl=c;var f={};l(i,function(e){if(e.addClass("schema-form-ignore"),o.prepend(e),o[0].querySelectorAll){var t=o[0].querySelectorAll("[ng-model]");if(t)for(var r=0;r<t.length;r++){var n=t[r].getAttribute("ng-model");f[n.substring(n.indexOf(".")+1)]=!0}}});var s={};i.$watch(function(){var c=i.schema,l=i.initialForm||["*"];if(l&&c&&c.type&&(s.form!==l||s.schema!==c)&&Object.keys(c.properties).length>0){s.schema=c,s.form=l;var m=t.merge(c,l,f),p=document.createDocumentFragment();i.schemaForm={form:m,schema:c},angular.forEach(m,function(e,t){var a=document.createElement(u.sfDecorator||n(r.defaultDecorator,"-"));a.setAttribute("form","schemaForm.form["+t+"]"),p.appendChild(a)}),o.children(":not(.schema-form-ignore)").remove(),o[0].appendChild(p),e(o.children())(i),a(c,function(e,t){angular.isDefined(e["default"])&&i.$eval("model."+t+" = model."+t+" || defaltValue",{defaltValue:e["default"]})})}})}}}]),angular.module("schemaForm").directive("schemaValidate",function(){return{restrict:"A",scope:!1,require:"ngModel",link:function(e,t,r,n){e.ngModel=n;var a=null,i=e.$eval(r.schemaValidate);n.$parsers.unshift(function(t){if(i||(i=e.$eval(r.schemaValidate)),!i)return t;if(angular.isUndefined(t))return void 0;var o=t;"integer"===i.type?o=parseInt(o,10):"number"===i.type?o=parseFloat(o,10):"boolean"===i.type&&"string"==typeof t&&("true"===t?o=!0:"false"===t&&(o=!1));var u=tv4.validateResult(o,i);return u.valid?(n.$setValidity("schema",!0),a=null,t):(n.$setValidity("schema",!1),void(a=u.error))}),e.hasSuccess=function(){return n.$valid&&(!n.$pristine||!n.$isEmpty(n.$modelValue))},e.hasError=function(){return n.$invalid&&!n.$pristine},e.schemaError=function(){return a}}}});