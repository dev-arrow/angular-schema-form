angular.module("schemaForm",[]),angular.module("schemaForm").provider("schemaFormDecorators",["$compileProvider",function(e){var r="bootstrapDecorator",t={},n=function(e,r){for(var n=t[e],a=n.rules,i=0;i<a.length;i++){var o=a[i](r);if(o)return o}return n.mappings[r.type]?n.mappings[r.type]:n.mappings["default"]};this.create=function(a,i,o){t[a]={mappings:i||{},rules:o||[]},t[r]||(r=a),e.directive(a,["$parse","$compile","$http","$templateCache",function(e,r,t,i){return{restrict:"AE",replace:!0,transclude:!1,scope:!0,link:function(e,o,u){var c=e.$watch(u.form,function(u){e.form=u;var m=n(a,u);t.get(m,{cache:i}).then(function(t){var n=t.data.replace(/\$\$value\$\$/g,"model."+u.key);r(n)(e,function(e){o.replaceWith(e)})}),c()});e.showTitle=function(){return e.form&&e.form.notitle!==!0&&e.form.title},e.checkboxValuesToList=function(e){var r=[];return angular.forEach(e,function(e,t){e&&r.push(t)}),r}}}}])},this.directive=function(e){return e=e||r,t[e]},this.$get=function(){return{directive:function(e){return t[e]},defaultDecorator:r}}}]),angular.module("schemaForm").factory("schemaForm",[function(){var e={};e.merge=function(r,t,n){t=t||["*"];var a=e.defaults(r,n),i=t.indexOf("*");if(-1!==i)return t=t.slice(0,i).concat(a.form).concat(t.slice(i+1));var o=a.lookup;return t.map(function(e){return"string"==typeof e&&(e={key:e}),e.key&&o[e.key]?angular.extend(o[e.key],e):e})};var r=function(e,r){var t={};return e.title&&(t.title=e.title),e.description&&(t.description=e.description),(r.required===!0||e.required===!0)&&(t.required=!0),e.default&&(t.default=e.default),e.maxLength&&(t.maxlength=e.maxLength),e.minLength&&(t.minlength=e.maxLength),(e.readOnly||e.readonly)&&(t.readonly=e.readOnly||e.readonly),e.minimum&&(t.minimum=e.minimum+(e.exclusiveMinimum?1:0)),e.maximum&&(t.maximum=e.maximum-(e.exclusiveMaximum?1:0)),t.schema=e,t},t=function(e,t,n){if("string"===t.type&&!t.enum){var a=r(t,n);return a.key=n.path,a.type="text",n.lookup[n.path]=a,a}},n=function(e,t,n){if("number"===t.type){var a=r(t,n);return a.key=n.path,a.type="number",n.lookup[n.path]=a,a}},a=function(e,t,n){if("integer"===t.type){var a=r(t,n);return a.key=n.path,a.type="number",n.lookup[n.path]=a,a}},i=function(e,t,n){if("boolean"===t.type){var a=r(t,n);return a.key=n.path,a.type="checkbox",n.lookup[n.path]=a,a}},o=function(e,t,n){if("string"===t.type&&t.enum){var a=r(t,n);return a.key=n.path,a.type="select",a.titleMap={},t.enum.forEach(function(e){a.titleMap[e]=e}),n.lookup[n.path]=a,a}},u=function(e,t,n){if("array"===t.type&&t.items&&t.items.enum){var a=r(t,n);return a.key=n.path,a.type="checkboxes",a.titleMap={},t.items.enum.forEach(function(e){a.titleMap[e]=e}),n.lookup[n.path]=a,a}},c=function(e,t,n){if("object"===t.type){var a=r(t,n);return a.type="fieldset",a.items=[],angular.forEach(t.properties,function(e,r){var i=n.path+"."+r;if(n.ignore[i]!==!0){var o=t.required&&-1!==t.required.indexOf(r),u=l(r,e,{path:i,required:o||!1,lookup:n.lookup,ignore:n.ignore});u&&a.items.push(u)}}),a}},m=[t,o,c,n,a,i,u],l=function(e,r,t){for(var n,a=0;a<m.length;a++)if(n=m[a](e,r,t))return n};return e.defaults=function(e,r){var t=[],n={};if(r=r||{},"object"!==e.type)throw new Exception('Not implemented. Only type "object" allowed at root level of schema.');return angular.forEach(e.properties,function(a,i){if(r[i]!==!0){var o=e.required&&-1!==e.required.indexOf(i),u=l(i,a,{path:i,lookup:n,ignore:r,required:o});u&&t.push(u)}}),{form:t,lookup:n}},e}]),angular.module("schemaForm").directive("sfSchema",["$compile","schemaForm","schemaFormDecorators",function(e,r,t){function n(e,r){return r=r||"_",e.replace(i,function(e,t){return(t?r:"")+e.toLowerCase()})}var a=function(e,r,t){t=t||"",r(e,t),angular.forEach(e.properties,function(e,n){a(e,r,""===t?n:t+"."+n)})},i=/[A-Z]/g;return{scope:{schema:"=sfSchema",initialForm:"=sfForm",model:"=sfModel"},replace:!1,restrict:"A",transclude:!0,require:"?form",link:function(i,o,u,c,m){i.formCtrl=c;var l={};m(i,function(e){e.addClass("schema-form-ignore"),o.prepend(e),o.find("[ng-model]").each(function(){var e=this.getAttribute("ng-model");l[e.substring(e.indexOf(".")+1)]=!0})});var f={};i.$watch(function(){var c=i.schema,m=i.initialForm||["*"];if(m&&c&&(f.form!==m||f.schema!==c)){f.schema=c,f.form=m;var s=r.merge(c,m,l),p=document.createDocumentFragment();i.schemaForm={form:s,schema:c},angular.forEach(s,function(e,r){var a=document.createElement(u.sfDecorator||n(t.defaultDecorator,"-"));a.setAttribute("type",e.type),a.setAttribute("form","schemaForm.form["+r+"]"),p.appendChild(a)}),o.children(":not(.schema-form-ignore)").remove(),o[0].appendChild(p),e(o.children())(i),a(c,function(e,r){angular.isDefined(e["default"])&&i.$eval("model."+r+" = model."+r+" || defaltValue",{defaltValue:e["default"]})})}})}}}]),angular.module("schemaForm").directive("schemaValidate",function(){return{restrict:"A",scope:!1,require:"ngModel",link:function(e,r,t,n){e.ngModel=n;var a=e.$eval(t.schemaValidate);n.$parsers.unshift(function(r){if(a||(a=e.$eval(t.schemaValidate)),angular.isUndefined(r))return void 0;var i=r;"integer"===a.type?i=parseInt(i,10):"number"===a.type?i=parseFloat(i,10):"boolean"===a.type&&"string"==typeof r&&("true"===r?i=!0:"false"===r&&(i=!1));var o=tv4.validateResult(i,a);return o.valid?(n.$setValidity("schema",!0),r):(n.$setValidity("schema",!1),void(e.schemaError=o.error.message))}),e.hasError=function(){return e.ngModel.$invalid&&!e.ngModel.$pristine}}}});