angular.module("schemaForm",[]),angular.module("schemaForm").provider("schemaFormDecorators",["$compileProvider",function(e){var r={},t=function(e,t){for(var n=r[e],a=n.rules,i=0;i<a.length;i++){var o=a[i](t);if(o)return o}return n.mappings[t.type]?n.mappings[t.type]:n.mappings["default"]};this.create=function(n,a,i){r[n]={mappings:a||{},rules:i||[]},e.directive(n,["$parse","$compile","$http","$templateCache",function(e,r,a,i){return{restrict:"AE",replace:!0,transclude:!1,scope:!0,link:function(e,o,u){var c=e.$watch(u.form,function(u){e.form=u;var m=t(n,u);a.get(m,{cache:i}).then(function(t){var n=t.data.replace(/\$\$value\$\$/g,"model."+u.key);r(n)(e,function(e){o.replaceWith(e)})}),c()});e.showTitle=function(){return e.form&&e.form.notitle!==!0&&e.form.title},e.checkboxValuesToList=function(e){var r=[];return angular.forEach(e,function(e,t){e&&r.push(t)}),r}}}}])},this.directive=function(e){return r[e]},this.$get=function(){return function(e){return r[e]}}}]),angular.module("schemaForm").factory("schemaForm",[function(){var e={};e.merge=function(r,t,n){t=t||["*"];var a=e.defaults(r,n),i=t.indexOf("*");if(-1!==i)return t=t.slice(0,i).concat(a.form).concat(t.slice(i+1));var o=a.lookup;return t.map(function(e){return"string"==typeof e&&(e={key:e}),e.key&&o[e.key]?angular.extend(o[e.key],e):e})};var r=function(e,r){var t={};return e.title&&(t.title=e.title),e.description&&(t.description=e.description),(r.required===!0||e.required===!0)&&(t.required=!0),e.default&&(t.default=e.default),e.maxLength&&(t.maxlength=e.maxLength),e.minLength&&(t.minlength=e.maxLength),(e.readOnly||e.readonly)&&(t.readonly=e.readOnly||e.readonly),e.minimum&&(t.minimum=e.minimum+(e.exclusiveMinimum?1:0)),e.maximum&&(t.maximum=e.maximum-(e.exclusiveMaximum?1:0)),t.schema=e,t},t=function(e,t,n){if("string"===t.type&&!t.enum){var a=r(t,n);return a.key=n.path,a.type="text",n.lookup[n.path]=a,a}},n=function(e,t,n){if("number"===t.type){var a=r(t,n);return a.key=n.path,a.type="number",n.lookup[n.path]=a,a}},a=function(e,t,n){if("integer"===t.type){var a=r(t,n);return a.key=n.path,a.type="number",n.lookup[n.path]=a,a}},i=function(e,t,n){if("boolean"===t.type){var a=r(t,n);return a.key=n.path,a.type="checkbox",n.lookup[n.path]=a,a}},o=function(e,t,n){if("string"===t.type&&t.enum){var a=r(t,n);return a.key=n.path,a.type="select",a.titleMap={},t.enum.forEach(function(e){a.titleMap[e]=e}),n.lookup[n.path]=a,a}},u=function(e,t,n){if("array"===t.type&&t.items&&t.items.enum){var a=r(t,n);return a.key=n.path,a.type="checkboxes",a.titleMap={},t.items.enum.forEach(function(e){a.titleMap[e]=e}),n.lookup[n.path]=a,a}},c=function(e,t,n){if("object"===t.type){var a=r(t,n);return a.type="fieldset",a.items=[],angular.forEach(t.properties,function(e,r){var i=n.path+"."+r;if(n.ignore[i]!==!0){var o=t.required&&-1!==t.required.indexOf(r),u=l(r,e,{path:i,required:o||!1,lookup:n.lookup,ignore:n.ignore});u&&a.items.push(u)}}),a}},m=[t,o,c,n,a,i,u],l=function(e,r,t){for(var n,a=0;a<m.length;a++)if(n=m[a](e,r,t))return n};return e.defaults=function(e,r){var t=[],n={};if(r=r||{},"object"!==e.type)throw new Exception('Not implemented. Only type "object" allowed at root level of schema.');return angular.forEach(e.properties,function(a,i){if(r[i]!==!0){var o=e.required&&-1!==e.required.indexOf(i),u=l(i,a,{path:i,lookup:n,ignore:r,required:o});u&&t.push(u)}}),{form:t,lookup:n}},e}]),angular.module("schemaForm").directive("sfSchema",["$compile","schemaForm",function(e,r){var t=function(e,r,n){n=n||"",r(e,n),angular.forEach(e.properties,function(e,a){t(e,r,""===n?a:n+"."+a)})};return{scope:{schema:"=sfSchema",initialForm:"=sfForm",model:"=sfModel"},replace:!1,restrict:"A",transclude:!0,require:"?form",link:function(n,a,i,o,u){n.formCtrl=o;var c={};u(n,function(e){e.addClass("schema-form-ignore"),a.prepend(e),a.find("[ng-model]").each(function(){var e=this.getAttribute("ng-model");c[e.substring(e.indexOf(".")+1)]=!0})});var m={};n.$watch(function(){var o=n.schema,u=n.initialForm||["*"];if(u&&o&&(m.form!==u||m.schema!==o)){m.schema=o,m.form=u;var l=r.merge(o,u,c),f=document.createDocumentFragment();n.schemaForm={form:l,schema:o},angular.forEach(l,function(e,r){var t=document.createElement(i.sfDecorator||"bootstrap-decorator");t.setAttribute("type",e.type),t.setAttribute("form","schemaForm.form["+r+"]"),f.appendChild(t)}),a.children(":not(.schema-form-ignore)").remove(),a[0].appendChild(f),e(a.children())(n),t(o,function(e,r){angular.isDefined(e["default"])&&n.$eval("model."+r+" = model."+r+" || defaltValue",{defaltValue:e["default"]})})}})}}}]),angular.module("schemaForm").directive("schemaValidate",function(){return{restrict:"A",scope:!1,require:"ngModel",link:function(e,r,t,n){e.ngModel=n;var a=e.$eval(t.schemaValidate);n.$parsers.unshift(function(r){if(a||(a=e.$eval(t.schemaValidate)),angular.isUndefined(r))return void 0;var i=r;"integer"===a.type?i=parseInt(i,10):"number"===a.type?i=parseFloat(i,10):"boolean"===a.type&&"string"==typeof r&&("true"===r?i=!0:"false"===r&&(i=!1));var o=tv4.validateResult(i,a);return o.valid?(n.$setValidity("schema",!0),r):(n.$setValidity("schema",!1),void(e.schemaError=o.error.message))}),e.hasError=function(){return e.ngModel.$invalid&&!e.ngModel.$pristine}}}});