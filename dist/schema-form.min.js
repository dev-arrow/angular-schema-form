var deps=["ObjectPath"];try{angular.module("ngSanitize"),deps.push("ngSanitize")}catch(e){}try{angular.module("ui.sortable"),deps.push("ui.sortable")}catch(e){}angular.module("schemaForm",deps),angular.module("schemaForm").factory("sfSelect",["ObjectPath",function(e){var r=/^\d+$/;return function(t,n,a){n||(n=this);var i="string"==typeof t?e.parse(t):t;if("undefined"!=typeof a&&1===i.length)return n[i[0]]=a,n;"undefined"!=typeof a&&"undefined"==typeof n[i[0]]&&(n[i[0]]=i.length>2&&r.test(i[1])?[]:{});for(var o=n[i[0]],u=1;u<i.length;u++){if(""===i[u])return void 0;if("undefined"!=typeof a){if(u===i.length-1)return o[i[u]]=a,a;var c=o[i[u]];("undefined"==typeof c||null===c)&&(c=r.test(i[u+1])?[]:{},o[i[u]]=c),o=c}else o&&(o=o[i[u]])}return o}}]),angular.module("schemaForm").provider("schemaFormDecorators",["$compileProvider","ObjectPathProvider",function(e,r){var t="",n={},a=function(e,r){"sfDecorator"===e&&(e=t);for(var a=n[e],i=a.rules,o=0;o<i.length;o++){var u=i[o](r);if(u)return u}return a.mappings[r.type]?a.mappings[r.type]:a.mappings["default"]},i=function(t){e.directive(t,["$parse","$compile","$http","$templateCache",function(e,n,i,o){return{restrict:"AE",replace:!1,transclude:!1,scope:!0,require:"?^sfSchema",link:function(e,u,c,s){var l=e.$watch(c.form,function(c){if(c){e.form=c;var s=a(t,c);i.get(s,{cache:o}).then(function(t){var a=c.key?r.stringify(c.key).replace(/"/g,"&quot;"):"",i=t.data.replace(/\$\$value\$\$/g,"model"+a);u.html(i),n(u.contents())(e)}),l()}});e.showTitle=function(){return e.form&&e.form.notitle!==!0&&e.form.title},e.checkboxValuesToList=function(e){var r=[];return angular.forEach(e,function(e,t){e&&r.push(t)}),r},e.buttonClick=function(r,t){angular.isFunction(t.onClick)?t.onClick(r,t):angular.isString(t.onClick)&&(s?s.evalInParentScope(t.onClick,{$event:r,form:t}):e.$eval(t.onClick,{$event:r,form:t}))},e.evalExpr=function(r,t){return s?s.evalInParentScope(r,t):e.$eval(r,t)},e.evalInScope=function(r,t){return r?e.$eval(r,t):void 0},e.errorMessage=function(r){return e.form.validationMessage?r?angular.isString(e.form.validationMessage)?e.form.validationMessage:e.form.validationMessage[r.code]||e.form.validationMessage["default"]:e.form.validationMessage.required||e.form.validationMessage["default"]||e.form.validationMessage:r?r.message:"Required"}}}}])},o=function(r,t,n){n=angular.isDefined(n)?n:!1,e.directive("sf"+angular.uppercase(r[0])+r.substr(1),function(){return{restrict:"EAC",scope:!0,replace:!0,transclude:n,template:'<sf-decorator form="form"></sf-decorator>',link:function(e,t,n){var a={items:"c",titleMap:"c",schema:"c"},i={type:r},o=!0;angular.forEach(n,function(r,t){if("$"!==t[0]&&0!==t.indexOf("ng")&&"sfField"!==t){var u=function(r){angular.isDefined(r)&&r!==i[t]&&(i[t]=r,o&&i.type&&(i.key||angular.isUndefined(n.key))&&(e.form=i,o=!1))};"model"===t?e.$watch(r,function(r){r&&e.model!==r&&(e.model=r)}):"c"===a[t]?e.$watchCollection(r,u):n.$observe(t,u)}})}}})};this.createDecorator=function(e,r,a){n[e]={mappings:r||{},rules:a||[]},n[t]||(t=e),i(e)},this.createDirective=o,this.createDirectives=function(e){angular.forEach(e,function(e,r){o(r,e)})},this.directive=function(e){return e=e||t,n[e]},this.addMapping=function(e,r,t){n[e]&&(n[e].mappings[r]=t)},this.$get=function(){return{directive:function(e){return n[e]},defaultDecorator:t}},i("sfDecorator")}]),angular.module("schemaForm").provider("schemaForm",["ObjectPathProvider",function(e){var r=function(e,r,t){var n=f[r.type];if(n)for(var a,i=0;i<n.length;i++)if(a=n[i](e,r,t))return a},t=function(e,r){var t={};return e.title&&(t.title=e.title),e.description&&(t.description=e.description),(r.required===!0||e.required===!0)&&(t.required=!0),e.default&&(t.default=e.default),e.maxLength&&(t.maxlength=e.maxLength),e.minLength&&(t.minlength=e.maxLength),(e.readOnly||e.readonly)&&(t.readonly=e.readOnly||e.readonly),e.minimum&&(t.minimum=e.minimum+(e.exclusiveMinimum?1:0)),e.maximum&&(t.maximum=e.maximum-(e.exclusiveMaximum?1:0)),e.validationMessage&&(t.validationMessage=e.validationMessage),e.enumNames&&(t.titleMap=e.enumNames),t.schema=e,t},n=function(r,n,a){if("string"===n.type&&!n.enum){var i=t(n,a);return i.key=a.path,i.type="text",a.lookup[e.stringify(a.path)]=i,i}},a=function(r,n,a){if("number"===n.type){var i=t(n,a);return i.key=a.path,i.type="number",a.lookup[e.stringify(a.path)]=i,i}},i=function(r,n,a){if("integer"===n.type){var i=t(n,a);return i.key=a.path,i.type="number",a.lookup[e.stringify(a.path)]=i,i}},o=function(r,n,a){if("boolean"===n.type){var i=t(n,a);return i.key=a.path,i.type="checkbox",a.lookup[e.stringify(a.path)]=i,i}},u=function(r,n,a){if("string"===n.type&&n.enum){var i=t(n,a);return i.key=a.path,i.type="select",i.titleMap||(i.titleMap={},n.enum.forEach(function(e){i.titleMap[e]=e})),a.lookup[e.stringify(a.path)]=i,i}},c=function(r,n,a){if("array"===n.type&&n.items&&n.items.enum){var i=t(n,a);return i.key=a.path,i.type="checkboxes",i.titleMap||(i.titleMap={},n.items.enum.forEach(function(e){i.titleMap[e]=e})),a.lookup[e.stringify(a.path)]=i,i}},s=function(n,a,i){if("object"===a.type){var o=t(a,i);return o.type="fieldset",o.items=[],i.lookup[e.stringify(i.path)]=o,angular.forEach(a.properties,function(t,n){var u=i.path.slice();if(u.push(n),i.ignore[e.stringify(u)]!==!0){var c=a.required&&-1!==a.required.indexOf(n),s=r(n,t,{path:u,required:c||!1,lookup:i.lookup,ignore:i.ignore});s&&o.items.push(s)}}),o}},l=function(n,a,i){if("array"===a.type){var o=t(a,i);o.type="array",o.key=i.path,i.lookup[e.stringify(i.path)]=o;var u=a.required&&-1!==a.required.indexOf(i.path(i.path.length-1)),c=i.path.slice();return c.push(""),o.items=[r(i.path,a.items,{path:c,required:u||!1,lookup:i.lookup,ignore:i.ignore})],o}},f={string:[u,n],object:[s],number:[a],integer:[i],"boolean":[o],array:[c,l]},m=function(e){return e};this.defaults=f,this.stdFormObj=t,this.postProcess=function(e){m=e},this.appendRule=function(e,r){f[e]||(f[e]=[]),f[e].push(r)},this.prependRule=function(e,r){f[e]||(f[e]=[]),f[e].unshift(r)},this.createStandardForm=t,this.$get=function(){var t={};return t.merge=function(r,n,a){n=n||["*"];var i=t.defaults(r,a),o=n.indexOf("*");if(-1!==o)return n=n.slice(0,o).concat(i.form).concat(n.slice(o+1));var u=i.lookup;return m(n.map(function(n){if("string"==typeof n&&(n={key:n}),n.items&&(n.items=t.merge(r,n.items,a)),n.tabs&&angular.forEach(n.tabs,function(e){e.items=t.merge(r,e.items,a)}),n.key){"string"==typeof n.key&&(n.key=e.parse(n.key));var i=e.stringify(n.key);if(u[i])return angular.extend(u[i],n)}return n}))},t.defaults=function(e,t){var n=[],a={};if(t=t||{},"object"!==e.type)throw new Error('Not implemented. Only type "object" allowed at root level of schema.');return angular.forEach(e.properties,function(i,o){if(o=[o],t[o]!==!0){var u=e.required&&-1!==e.required.indexOf(o[o.length-1]),c=r(o,i,{path:o,lookup:a,ignore:t,required:u});c&&n.push(c)}}),{form:n,lookup:a}},t.traverseSchema=function(e,r,t,n){n=angular.isDefined(n)?n:!0,t=t||[];var a=function(e,r,t){if(r(e,t),angular.forEach(e.properties,function(e,n){var i=t.slice();i.push(n),a(e,r,i)}),!n&&e.items){var i=t.slice();i.push(""),a(e.items,r,i)}};a(e,r,t||[])},t.traverseForm=function(e,r){r(e),angular.forEach(e.items,function(e){t.traverseForm(e,r)}),e.tabs&&angular.forEach(e.tabs,function(e){angular.forEach(e.items,function(e){t.traverseForm(e,r)})})},t}}]),angular.module("schemaForm").directive("sfArray",["sfSelect","schemaForm",function(e,r){var t=function(e){return function(r){r.key&&(r.key[r.key.indexOf("")]=e)}};return{restrict:"A",scope:!0,link:function(n,a,i){var o={},u=n.$watch(i.sfArray,function(a){var i=e(a.key,n.model);angular.isUndefined(i)&&(i=[],e(a.key,n.model,i)),n.modelArray=i;var c=a.items[0];a.items.length>1&&(c={type:"section",items:a.items}),n.copyWithIndex=function(e){if(!o[e]&&c){var n=angular.copy(c);n.arrayIndex=e,r.traverseForm(n,t(e)),o[e]=n}return o[e]},n.appendToArray=function(){var t=i.length,o=n.copyWithIndex(t);if(r.traverseForm(o,function(r){r.key&&angular.isDefined(r.default)&&e(r.key,n.model,r.default)}),t===i.length){var u=e("schema.items.type",a),c=null;"object"===u?c={}:"array"===u&&(c=[]),i.push(c)}},n.deleteFromArray=function(e){i.splice(e,1)},a.startEmpty!==!0&&0===i.length&&n.appendToArray(),u()})}}}]),angular.module("schemaForm").directive("sfChanged",function(){return{require:"ngModel",restrict:"AC",scope:!1,link:function(e,r,t,n){var a=e.$eval(t.sfChanged);a&&a.onChange&&n.$viewChangeListeners.push(function(){angular.isFunction(a.onChange)?a.onChange(n.$modelValue,a):e.evalExpr(a.onChange,{modelValue:n.$modelValue,form:a})})}}}),angular.module("schemaForm").directive("sfSchema",["$compile","schemaForm","schemaFormDecorators","sfSelect",function(e,r,t,n){function a(e,r){return r=r||"_",e.replace(i,function(e,t){return(t?r:"")+e.toLowerCase()})}var i=/[A-Z]/g;return{scope:{schema:"=sfSchema",initialForm:"=sfForm",model:"=sfModel"},controller:["$scope",function(e){this.evalInParentScope=function(r,t){return e.$parent.$eval(r,t)}}],replace:!1,restrict:"A",transclude:!0,require:"?form",link:function(i,o,u,c,s){i.formCtrl=c;var l={};s(i,function(e){if(e.addClass("schema-form-ignore"),o.prepend(e),o[0].querySelectorAll){var r=o[0].querySelectorAll("[ng-model]");if(r)for(var t=0;t<r.length;t++){var n=r[t].getAttribute("ng-model");l[n.substring(n.indexOf(".")+1)]=!0}}});var f={};i.$watch(function(){var c=i.schema,s=i.initialForm||["*"];if(s&&c&&c.type&&(f.form!==s||f.schema!==c)&&Object.keys(c.properties).length>0){f.schema=c,f.form=s;var m=r.merge(c,s,l),p=document.createDocumentFragment();i.schemaForm={form:m,schema:c},angular.forEach(m,function(e,r){var n=document.createElement(u.sfDecoratorName||a(t.defaultDecorator,"-"));n.setAttribute("form","schemaForm.form["+r+"]"),p.appendChild(n)}),o.children(":not(.schema-form-ignore)").remove(),o[0].appendChild(p),e(o.children())(i),r.traverseSchema(c,function(e,r){if(angular.isDefined(e["default"])){var t=n(r,i.model);angular.isUndefined(t)&&n(r,i.model,e["default"])}})}})}}}]),angular.module("schemaForm").directive("schemaValidate",function(){return{restrict:"A",scope:!1,require:"ngModel",link:function(e,r,t,n){e.ngModel=n;var a=null,i=e.$eval(t.schemaValidate);n.$parsers.unshift(function(r){if(i||(i=e.$eval(t.schemaValidate)),!i)return r;if(angular.isUndefined(r))return void 0;var o=r;"integer"===i.type?o=parseInt(o,10):"number"===i.type?o=parseFloat(o,10):"boolean"===i.type&&"string"==typeof r&&("true"===r?o=!0:"false"===r&&(o=!1));var u=tv4.validateResult(o,i);return u.valid?(n.$setValidity("schema",!0),a=null,r):(n.$setValidity("schema",!1),void(a=u.error))}),e.hasSuccess=function(){return n.$valid&&(!n.$pristine||!n.$isEmpty(n.$modelValue))},e.hasError=function(){return n.$invalid&&!n.$pristine},e.schemaError=function(){return a}}}});